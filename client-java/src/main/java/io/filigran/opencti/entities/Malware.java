package io.filigran.opencti.entities;

import io.filigran.opencti.OpenCTIApiClient;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;
import java.util.List;
import java.util.Map;
import java.util.UUID;

/**
 * Entity handler for OpenCTI Malware objects.
 *
 * @author Filigran Team
 * @since 6.9.6
 */
@Slf4j
public class Malware extends BaseEntity {

    private static final String STIX_NAMESPACE = "00abedb4-aa42-466c-9c01-fed23315a9b7";

    private static final String PROPERTIES = """
            id
            standard_id
            entity_type
            parent_types
            spec_version
            created_at
            updated_at
            createdBy {
                ... on Identity {
                    id
                    standard_id
                    entity_type
                    name
                }
            }
            objectMarking {
                id
                standard_id
                entity_type
                definition_type
                definition
                x_opencti_order
                x_opencti_color
            }
            objectLabel {
                id
                value
                color
            }
            externalReferences {
                edges {
                    node {
                        id
                        standard_id
                        entity_type
                        source_name
                        description
                        url
                        external_id
                    }
                }
            }
            revoked
            confidence
            created
            modified
            name
            description
            aliases
            malware_types
            is_family
            first_seen
            last_seen
            architecture_execution_envs
            implementation_languages
            capabilities
            killChainPhases {
                id
                standard_id
                entity_type
                kill_chain_name
                phase_name
                x_opencti_order
            }
            """;

    public Malware(OpenCTIApiClient client) {
        super(client);
    }

    @Override
    protected String getEntityType() {
        return "Malware";
    }

    @Override
    protected String getEntityName() {
        return "malware";
    }

    @Override
    protected String getEntityNamePlural() {
        return "malwares";
    }

    @Override
    protected String getProperties() {
        return PROPERTIES;
    }

    @Override
    protected String getOrderingEnum() {
        return "MalwaresOrdering";
    }

    /**
     * Generate a STIX ID for a Malware based on its name.
     *
     * @param name the malware name
     * @return the STIX ID
     */
    public static String generateId(String name) {
        String normalizedName = name.toLowerCase().strip();
        String data = "{\"name\":\"" + normalizedName + "\"}";
        UUID uuid = UUID.nameUUIDFromBytes((STIX_NAMESPACE + data).getBytes(StandardCharsets.UTF_8));
        return "malware--" + uuid;
    }

    /**
     * Create a new Malware.
     *
     * @param name the malware name (required)
     * @param params additional parameters
     * @return the created malware
     */
    @SuppressWarnings("unchecked")
    public Map<String, Object> create(String name, Object... params) {
        if (name == null || name.isBlank()) {
            log.error("Missing required parameter: name");
            return null;
        }
        
        log.info("Creating Malware: {}", name);
        
        Map<String, Object> input = buildInput(params);
        input.put("name", name);
        
        String mutation = """
            mutation MalwareAdd($input: MalwareAddInput!) {
                malwareAdd(input: $input) {
                    id
                    standard_id
                    entity_type
                    parent_types
                }
            }
            """;
        
        Map<String, Object> result = client.query(mutation, Map.of("input", input));
        Map<String, Object> data = (Map<String, Object>) result.get("data");
        return client.processMultipleFields((Map<String, Object>) data.get("malwareAdd"));
    }

    /**
     * Create a new Malware with all parameters.
     *
     * @param stixId optional STIX ID
     * @param name the malware name
     * @param description optional description
     * @param aliases optional list of aliases
     * @param malwareTypes optional list of malware types
     * @param isFamily whether this is a malware family
     * @param firstSeen optional first seen date
     * @param lastSeen optional last seen date
     * @param architectureExecutionEnvs optional execution environments
     * @param implementationLanguages optional implementation languages
     * @param capabilities optional capabilities
     * @param killChainPhases optional kill chain phase IDs
     * @param createdBy optional creator identity ID
     * @param objectMarking optional marking definition IDs
     * @param objectLabel optional label IDs
     * @param externalReferences optional external reference IDs
     * @param revoked whether the malware is revoked
     * @param confidence optional confidence level
     * @param created optional creation date
     * @param modified optional modification date
     * @param update whether to update if exists
     * @return the created malware
     */
    public Map<String, Object> create(
            String stixId,
            String name,
            String description,
            List<String> aliases,
            List<String> malwareTypes,
            Boolean isFamily,
            String firstSeen,
            String lastSeen,
            List<String> architectureExecutionEnvs,
            List<String> implementationLanguages,
            List<String> capabilities,
            List<String> killChainPhases,
            String createdBy,
            List<String> objectMarking,
            List<String> objectLabel,
            List<String> externalReferences,
            Boolean revoked,
            Integer confidence,
            String created,
            String modified,
            boolean update) {
        
        return create(name,
            "stix_id", stixId,
            "description", description,
            "aliases", aliases,
            "malware_types", malwareTypes,
            "is_family", isFamily,
            "first_seen", firstSeen,
            "last_seen", lastSeen,
            "architecture_execution_envs", architectureExecutionEnvs,
            "implementation_languages", implementationLanguages,
            "capabilities", capabilities,
            "killChainPhases", killChainPhases,
            "createdBy", createdBy,
            "objectMarking", objectMarking,
            "objectLabel", objectLabel,
            "externalReferences", externalReferences,
            "revoked", revoked,
            "confidence", confidence,
            "created", created,
            "modified", modified,
            "update", update
        );
    }

    /**
     * Import a Malware from a STIX2 object.
     *
     * @param stixObject the STIX2 malware object
     * @param extras extra parameters (created_by_id, object_marking_ids, etc.)
     * @param update whether to update if exists
     * @return the imported malware
     */
    @SuppressWarnings("unchecked")
    public Map<String, Object> importFromStix2(Map<String, Object> stixObject, Map<String, Object> extras, boolean update) {
        if (stixObject == null) {
            log.error("Missing parameter: stixObject");
            return null;
        }
        
        return create(
            (String) stixObject.get("id"),
            (String) stixObject.get("name"),
            (String) stixObject.get("description"),
            (List<String>) stixObject.get("aliases"),
            (List<String>) stixObject.get("malware_types"),
            stixObject.containsKey("is_family") ? (Boolean) stixObject.get("is_family") : false,
            (String) stixObject.get("first_seen"),
            (String) stixObject.get("last_seen"),
            (List<String>) stixObject.get("architecture_execution_envs"),
            (List<String>) stixObject.get("implementation_languages"),
            (List<String>) stixObject.get("capabilities"),
            extras != null ? (List<String>) extras.get("kill_chain_phases_ids") : null,
            extras != null ? (String) extras.get("created_by_id") : null,
            extras != null ? (List<String>) extras.get("object_marking_ids") : null,
            extras != null ? (List<String>) extras.get("object_label_ids") : null,
            extras != null ? (List<String>) extras.get("external_references_ids") : null,
            stixObject.containsKey("revoked") ? (Boolean) stixObject.get("revoked") : null,
            stixObject.containsKey("confidence") ? ((Number) stixObject.get("confidence")).intValue() : null,
            (String) stixObject.get("created"),
            (String) stixObject.get("modified"),
            update
        );
    }
}

