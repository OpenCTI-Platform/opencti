package io.filigran.opencti.entities;

import com.fasterxml.jackson.databind.ObjectMapper;
import io.filigran.opencti.OpenCTIApiClient;
import okhttp3.mockwebserver.MockResponse;
import okhttp3.mockwebserver.MockWebServer;
import org.junit.jupiter.api.*;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.*;

/**
 * Unit tests for Malware entity.
 */
@Tag("unit")
class MalwareTest {

    private MockWebServer mockWebServer;
    private OpenCTIApiClient client;
    private final ObjectMapper objectMapper = new ObjectMapper();

    @BeforeEach
    void setUp() throws IOException {
        mockWebServer = new MockWebServer();
        mockWebServer.start();
        
        client = OpenCTIApiClient.builder()
            .url(mockWebServer.url("").toString().replaceAll("/$", ""))
            .token("test-token")
            .performHealthCheck(false)
            .sslVerify(false)
            .build();
    }

    @AfterEach
    void tearDown() throws IOException {
        mockWebServer.shutdown();
    }

    @Test
    @DisplayName("Should generate consistent STIX IDs")
    void shouldGenerateConsistentStixIds() {
        String id1 = Malware.generateId("WannaCry");
        String id2 = Malware.generateId("WannaCry");
        String id3 = Malware.generateId("wannacry");
        String id4 = Malware.generateId("NotPetya");
        
        assertThat(id1).isEqualTo(id2);
        assertThat(id1).isEqualTo(id3); // Case insensitive
        assertThat(id1).isNotEqualTo(id4);
        assertThat(id1).startsWith("malware--");
    }

    @Test
    @DisplayName("Should create malware successfully")
    void shouldCreateMalwareSuccessfully() throws Exception {
        Map<String, Object> responseData = Map.of(
            "data", Map.of(
                "malwareAdd", Map.of(
                    "id", "malware-123",
                    "standard_id", "malware--uuid",
                    "entity_type", "Malware",
                    "parent_types", List.of("Stix-Domain-Object", "Stix-Core-Object")
                )
            )
        );
        
        mockWebServer.enqueue(new MockResponse()
            .setBody(objectMapper.writeValueAsString(responseData))
            .addHeader("Content-Type", "application/json"));
        
        Map<String, Object> result = client.getMalware().create("WannaCry",
            "description", "A ransomware",
            "is_family", true
        );
        
        assertThat(result).isNotNull();
        assertThat(result.get("id")).isEqualTo("malware-123");
        assertThat(result.get("entity_type")).isEqualTo("Malware");
    }

    @Test
    @DisplayName("Should return null when name is missing")
    void shouldReturnNullWhenNameIsMissing() {
        Map<String, Object> result = client.getMalware().create(null);
        
        assertThat(result).isNull();
    }

    @Test
    @DisplayName("Should list malwares successfully")
    void shouldListMalwaresSuccessfully() throws Exception {
        Map<String, Object> pageInfo = new HashMap<>();
        pageInfo.put("hasNextPage", false);
        pageInfo.put("endCursor", null);
        pageInfo.put("globalCount", 2);

        Map<String, Object> responseData = Map.of(
            "data", Map.of(
                "malwares", Map.of(
                    "edges", List.of(
                        Map.of("node", Map.of("id", "1", "name", "WannaCry")),
                        Map.of("node", Map.of("id", "2", "name", "NotPetya"))
                    ),
                    "pageInfo", pageInfo
                )
            )
        );
        
        mockWebServer.enqueue(new MockResponse()
            .setBody(objectMapper.writeValueAsString(responseData))
            .addHeader("Content-Type", "application/json"));
        
        var result = client.getMalware().list(null, null, 10, null, null, null);
        
        assertThat(result).hasSize(2);
        assertThat(result.get(0).get("name")).isEqualTo("WannaCry");
        assertThat(result.get(1).get("name")).isEqualTo("NotPetya");
    }

    @Test
    @DisplayName("Should read malware by ID")
    void shouldReadMalwareById() throws Exception {
        Map<String, Object> responseData = Map.of(
            "data", Map.of(
                "malware", Map.of(
                    "id", "malware-123",
                    "name", "WannaCry",
                    "description", "A ransomware",
                    "is_family", true
                )
            )
        );
        
        mockWebServer.enqueue(new MockResponse()
            .setBody(objectMapper.writeValueAsString(responseData))
            .addHeader("Content-Type", "application/json"));
        
        Map<String, Object> result = client.getMalware().read("malware-123");
        
        assertThat(result).isNotNull();
        assertThat(result.get("id")).isEqualTo("malware-123");
        assertThat(result.get("name")).isEqualTo("WannaCry");
    }

    @Test
    @DisplayName("Should import malware from STIX2")
    void shouldImportMalwareFromStix2() throws Exception {
        Map<String, Object> responseData = Map.of(
            "data", Map.of(
                "malwareAdd", Map.of(
                    "id", "malware-123",
                    "standard_id", "malware--uuid",
                    "entity_type", "Malware",
                    "parent_types", List.of("Stix-Domain-Object")
                )
            )
        );
        
        mockWebServer.enqueue(new MockResponse()
            .setBody(objectMapper.writeValueAsString(responseData))
            .addHeader("Content-Type", "application/json"));
        
        Map<String, Object> stixObject = Map.of(
            "id", "malware--uuid",
            "type", "malware",
            "name", "WannaCry",
            "description", "A ransomware",
            "is_family", true,
            "malware_types", List.of("ransomware"),
            "created", "2021-01-01T00:00:00Z",
            "modified", "2021-01-01T00:00:00Z"
        );
        
        Map<String, Object> extras = Map.of(
            "created_by_id", "identity-123",
            "object_marking_ids", List.of("marking-tlp-white")
        );
        
        Map<String, Object> result = client.getMalware().importFromStix2(stixObject, extras, false);
        
        assertThat(result).isNotNull();
        assertThat(result.get("id")).isEqualTo("malware-123");
    }
}

