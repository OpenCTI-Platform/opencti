name: Build OpenCTI Platform and worker images

on:
  workflow_call:
    inputs:
      image_tag:
        description: "Image Tag"
        type: string
        default: ${{ github.sha }}
      checkout_ref:
        description: "Reference of the branch or commit sha"
        type: string
        default: ${{ github.sha }}
      dockerfile_target:
        description: "Target to build in the multi stage docker file - testing or app"
        type: string
        required: false
        default: app
      is_client_python_local:
        description: "Use client python from the same commit"
        type: boolean
        required: false
        default: false
      is_fips:
        description: "Build FIPS compliant images"
        type: boolean
        required: false
        default: false
      is_publish_to_registry:
        description: "Publish image to registry. If false, will save the image as github artifact"
        type: boolean
        required: false
        default: false
      registry:
        description: "Registry used to publish the image"
        type: string
        required: false
        default: "docker.io/filigran"
    outputs:
      image-tag-version-cleaned:
        description: "Image tag after formatting"
        value: ${{ jobs.build-opencti-platform.outputs.version }}
      image-tag-cleaned:
        description: "Image tags including image name after formatting"
        value: ${{ jobs.build-opencti-platform.outputs.tags }}

jobs:
  build-opencti-platform:
    name: Build OpenCTI Platform image
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Simulate build
        continue-on-error: true
        run: echo "Simulate build"

  build-opencti-worker:
    name: Build OpenCTI Worker image
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Simulate build
        continue-on-error: true
        run: echo "Simulate build"
