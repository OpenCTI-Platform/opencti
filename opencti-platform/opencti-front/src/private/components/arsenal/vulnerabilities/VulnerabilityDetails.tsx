import React from 'react';
import { createFragmentContainer, graphql } from 'react-relay';
import { useTheme } from '@mui/styles';
import Paper from '@mui/material/Paper';
import Typography from '@mui/material/Typography';
import Grid from '@mui/material/Grid';
import { VulnerabilityDetails_vulnerability$data } from '@components/arsenal/vulnerabilities/__generated__/VulnerabilityDetails_vulnerability.graphql';
import type { Theme } from '../../../../components/Theme';
import { useFormatter } from '../../../../components/i18n';
import ExpandableMarkdown from '../../../../components/ExpandableMarkdown';
import { emptyFilled } from '../../../../utils/String';
import ItemBoolean from '../../../../components/ItemBoolean';
import FieldOrEmpty from '../../../../components/FieldOrEmpty';
import ItemSeverity from '../../../../components/ItemSeverity';
import ItemCvssScore from '../../../../components/ItemCvssScore';
import VulnerabilitySoftwaresRemediates from './VulnerabilitySoftwaresRemediates';
import VulnerabilitySoftwaresHas from './VulnerabilitySoftwaresHas';

type VulnerabilityDetailsProps = {
  vulnerability: VulnerabilityDetails_vulnerability$data
};

const VulnerabilityDetailsComponent = ({ vulnerability }: VulnerabilityDetailsProps) => {
  const theme = useTheme<Theme>();
  const { t_i18n } = useFormatter();

  return (
    <div style={{ height: '100%' }}>
      <Typography variant="h4">
        {t_i18n('Details')}
      </Typography>
      <Paper
        sx={{
          marginTop: theme.spacing(1),
          padding: theme.spacing(2),
        }}
        className={'paper-for-grid'}
        variant="outlined"
      >
        <Grid container spacing={2}>
          <Grid item xs={12} sx={{ marginBottom: '12px' }}>
            <Typography variant="h3" gutterBottom>
              {t_i18n('Description')}
            </Typography>
            <ExpandableMarkdown source={vulnerability.description} limit={400} />
          </Grid>
          <Grid item xs={6} sx={{ marginBottom: '12px' }}>
            <Typography variant="h3" gutterBottom>
              {t_i18n('CVSS3 - Score')}
            </Typography>
            <ItemCvssScore score={vulnerability.x_opencti_cvss_base_score} />
          </Grid>
          <Grid item xs={6} sx={{ marginBottom: '12px' }}>
            <Typography variant="h3" gutterBottom>
              {t_i18n('CVSS3 - Severity')}
            </Typography>
            <ItemSeverity
              severity={vulnerability.x_opencti_cvss_base_severity}
              label={vulnerability.x_opencti_cvss_base_severity || t_i18n('Unknown')}
            />
          </Grid>
          <Grid item xs={6}>
            <Typography variant="h3" gutterBottom>
              {t_i18n('CVSS3 - Availability impact (A)')}
            </Typography>
            <pre style={{ marginTop: 0 }}>
              {emptyFilled(vulnerability.x_opencti_cvss_availability_impact)}
            </pre>
          </Grid>
          <Grid item xs={6}>
            <Typography variant="h3" gutterBottom>
              {t_i18n('CVSS3 - Integrity impact (I)')}
            </Typography>
            <pre style={{ marginTop: 0 }}>
              {emptyFilled(vulnerability.x_opencti_cvss_integrity_impact)}
            </pre>
          </Grid>
          <Grid item xs={6}>
            <Typography variant="h3" gutterBottom>
              {t_i18n('CVSS3 - Confidentiality impact (C)')}
            </Typography>
            <pre style={{ marginTop: 0 }}>
              {emptyFilled(vulnerability.x_opencti_cvss_confidentiality_impact)}
            </pre>
          </Grid>
          <Grid item xs={6}>
            <Typography variant="h3" gutterBottom>
              {t_i18n('CVSS3 - Attack vector (AV)')}
            </Typography>
            <pre style={{ marginTop: 0 }}>
              {emptyFilled(vulnerability.x_opencti_cvss_attack_vector)}
            </pre>
          </Grid>
          <Grid item xs={6}>
            <Typography variant="h3" gutterBottom>
              {t_i18n('EPSS Score')}
            </Typography>
            <pre style={{ marginTop: 0 }}>
              {emptyFilled(vulnerability.x_opencti_epss_score)}
            </pre>
          </Grid>
          <Grid item xs={6}>
            <Typography variant="h3" gutterBottom>
              {t_i18n('EPSS Percentile')}
            </Typography>
            <pre style={{ marginTop: 0 }}>
              {emptyFilled(vulnerability.x_opencti_epss_percentile)}
            </pre>
          </Grid>
          <Grid item xs={6}>
            <Typography variant="h3" gutterBottom>
              {t_i18n('CISA KEV')}
            </Typography>
            <FieldOrEmpty source={vulnerability.x_opencti_cisa_kev}>
              <ItemBoolean
                status={vulnerability.x_opencti_cisa_kev}
                label={vulnerability.x_opencti_cisa_kev ? t_i18n('Yes') : t_i18n('No')}
                reverse
              />
            </FieldOrEmpty>
          </Grid>
        </Grid>
        <Grid container spacing={2}>
          <Grid item xs={6}>
            <VulnerabilitySoftwaresHas vulnerability={vulnerability} />
          </Grid>
          <Grid item xs={6}>
            <VulnerabilitySoftwaresRemediates vulnerability={vulnerability} />
          </Grid>
        </Grid>
      </Paper>
    </div>
  );
};

const VulnerabilityDetails = createFragmentContainer(
  VulnerabilityDetailsComponent,
  {
    vulnerability: graphql`
      fragment VulnerabilityDetails_vulnerability on Vulnerability {
        id
        name
        description
        x_opencti_aliases
        x_opencti_cvss_vector
        x_opencti_cvss_base_score
        x_opencti_cvss_base_severity
        x_opencti_cvss_attack_vector
        x_opencti_cvss_attack_complexity
        x_opencti_cvss_privileges_required
        x_opencti_cvss_user_interaction
        x_opencti_cvss_scope
        x_opencti_cvss_confidentiality_impact
        x_opencti_cvss_integrity_impact
        x_opencti_cvss_availability_impact
        x_opencti_cvss_exploit_code_maturity
        x_opencti_cvss_remediation_level
        x_opencti_cvss_report_confidence
        x_opencti_cvss_temporal_score
        x_opencti_cvss_v2_vector
        x_opencti_cvss_v2_base_score
        x_opencti_cvss_v2_access_vector
        x_opencti_cvss_v2_access_complexity
        x_opencti_cvss_v2_authentication
        x_opencti_cvss_v2_confidentiality_impact
        x_opencti_cvss_v2_integrity_impact
        x_opencti_cvss_v2_availability_impact
        x_opencti_cvss_v2_exploitability
        x_opencti_cvss_v2_remediation_level
        x_opencti_cvss_v2_report_confidence
        x_opencti_cvss_v2_temporal_score
        x_opencti_cvss_v4_vector
        x_opencti_cvss_v4_base_score
        x_opencti_cvss_v4_base_severity
        x_opencti_cvss_v4_attack_vector
        x_opencti_cvss_v4_attack_complexity
        x_opencti_cvss_v4_attack_requirements
        x_opencti_cvss_v4_privileges_required
        x_opencti_cvss_v4_user_interaction
        x_opencti_cvss_v4_confidentiality_impact_v
        x_opencti_cvss_v4_confidentiality_impact_s
        x_opencti_cvss_v4_integrity_impact_v
        x_opencti_cvss_v4_integrity_impact_s
        x_opencti_cvss_v4_availability_impact_v
        x_opencti_cvss_v4_availability_impact_s
        x_opencti_cvss_v4_exploit_maturity
        x_opencti_cwe
        x_opencti_cisa_kev
        x_opencti_epss_score
        x_opencti_epss_percentile
        x_opencti_score
        ...VulnerabilitySoftwaresHas_vulnerability
        ...VulnerabilitySoftwaresRemediates_vulnerability
      }
    `,
  },
);

export default VulnerabilityDetails;
