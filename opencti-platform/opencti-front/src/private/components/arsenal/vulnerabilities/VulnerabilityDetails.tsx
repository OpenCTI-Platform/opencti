import React from 'react';
import { createFragmentContainer, graphql } from 'react-relay';
import Grid from '@mui/material/Grid';
import { VulnerabilityDetails_vulnerability$data } from '@components/arsenal/vulnerabilities/__generated__/VulnerabilityDetails_vulnerability.graphql';
import Box from '@mui/material/Box';
import Tabs from '@mui/material/Tabs';
import Tab from '@mui/material/Tab';
import { useFormatter } from '../../../../components/i18n';
import ExpandableMarkdown from '../../../../components/ExpandableMarkdown';
import ItemBoolean from '../../../../components/ItemBoolean';
import FieldOrEmpty from '../../../../components/FieldOrEmpty';
import ItemSeverity from '../../../../components/ItemSeverity';
import ItemCvssScore from '../../../../components/ItemCvssScore';
import VulnerabilitySoftwaresRemediates from './VulnerabilitySoftwaresRemediates';
import VulnerabilitySoftwaresHas from './VulnerabilitySoftwaresHas';
import ItemScore from '../../../../components/ItemScore';
import Card from '../../../../components/common/card/Card';
import Label from '../../../../components/common/label/Label';
import Tag from '../../../../components/common/tag/Tag';
import { Stack } from '@mui/material';
import TextList from '../../../../components/common/text/TextList';

const getCvssCriticity = (score: number | null | undefined): string | null => {
  if (typeof score !== 'number' || score < 0 || score > 10) return null;
  if (score === 0.0) return 'Unknown';
  if (score <= 3.9) return 'LOW';
  if (score <= 6.9) return 'MEDIUM';
  if (score <= 8.9) return 'HIGH';
  return 'CRITICAL';
};

type VulnerabilityDetailsProps = {
  vulnerability: VulnerabilityDetails_vulnerability$data;
};

const VulnerabilityDetailsComponent = ({ vulnerability }: VulnerabilityDetailsProps) => {
  const { t_i18n, fld } = useFormatter();
  const [value, setValue] = React.useState(1);
  const handleChange = (_: React.SyntheticEvent, newValue: number) => {
    setValue(newValue);
  };

  return (
    <div style={{ height: '100%' }}>
      <Card title={t_i18n('Details')}>
        <Grid container spacing={2}>
          <Grid item xs={12}>
            <Label>
              {t_i18n('Description')}
            </Label>
            <ExpandableMarkdown source={vulnerability.description} limit={400} />
          </Grid>
          <Grid item xs={6}>
            <Label>
              {t_i18n('EPSS Score')}
            </Label>
            <FieldOrEmpty source={vulnerability.x_opencti_epss_score}>
              <Tag label={vulnerability.x_opencti_epss_score}></Tag>
            </FieldOrEmpty>
          </Grid>
          <Grid item xs={6}>
            <Label>
              {t_i18n('EPSS Percentile')}
            </Label>
            <FieldOrEmpty source={vulnerability.x_opencti_epss_percentile}>
              <Tag label={vulnerability.x_opencti_epss_percentile}>
              </Tag>
            </FieldOrEmpty>
          </Grid>
          <Grid item xs={6}>
            <Label>
              {t_i18n('Score')}
            </Label>
            <ItemScore score={vulnerability.x_opencti_score} />
          </Grid>
          <Grid item xs={6}>
            <Label>
              {t_i18n('CISA KEV')}
            </Label>
            <FieldOrEmpty source={vulnerability.x_opencti_cisa_kev}>
              <ItemBoolean
                status={vulnerability.x_opencti_cisa_kev}
                label={vulnerability.x_opencti_cisa_kev ? t_i18n('Yes') : t_i18n('No')}
                reverse
              />
            </FieldOrEmpty>
          </Grid>
          <Grid item xs={6}>
            <Label>
              {t_i18n('Associated CWE(s)')}
            </Label>
            <TextList
              list={vulnerability.x_opencti_cwe}
            />
          </Grid>
          <Grid item xs={6}>
            <Label>
              {t_i18n('First seen active')}
            </Label>
            <FieldOrEmpty source={vulnerability.x_opencti_first_seen_active}>
              {fld(vulnerability.x_opencti_first_seen_active)}
            </FieldOrEmpty>
          </Grid>
        </Grid>
        <Box sx={{ marginTop: 1, marginBottom: 1, flexGrow: 1, display: 'flex', height: 500, borderTop: 1, borderBottom: 1, borderColor: 'divider' }}>
          <Tabs
            value={value}
            onChange={handleChange}
            orientation="vertical"
            sx={{ borderRight: 1, borderColor: 'divider' }}
          >
            <Tab label={t_i18n('CVSS V2')} style={{ marginRight: 20, textTransform: 'none' }} />
            <Tab label={t_i18n('CVSS V3')} style={{ marginRight: 20, textTransform: 'none' }} />
            <Tab label={t_i18n('CVSS V4')} style={{ marginRight: 20, textTransform: 'none' }} />
          </Tabs>
          {value === 0 && (
            <Grid container spacing={2} style={{ margin: 10, alignSelf: 'flex-start' }}>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Score')}
                </Label>
                <Stack direction="row" gap={1}>
                  <ItemCvssScore score={vulnerability.x_opencti_cvss_v2_base_score ?? 0} />
                  <ItemSeverity
                    severity={getCvssCriticity(vulnerability.x_opencti_cvss_v2_base_score)}
                    label={getCvssCriticity(vulnerability.x_opencti_cvss_v2_base_score)}
                    variant="high"
                  />
                </Stack>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Vector')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v2_vector_string}>
                  <Tag label={vulnerability.x_opencti_cvss_v2_vector_string}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Access Vector (AV)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v2_access_vector}>
                  <Tag label={vulnerability.x_opencti_cvss_v2_access_vector}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Access Complexity (AC)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v2_access_complexity}>
                  <Tag label={vulnerability.x_opencti_cvss_v2_access_complexity}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Authentication (AU)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v2_authentication}>
                  <Tag label={vulnerability.x_opencti_cvss_v2_authentication}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Confidentiality Impact (C)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v2_confidentiality_impact}>
                  <Tag label={vulnerability.x_opencti_cvss_v2_confidentiality_impact}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Integrity Impact (I)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v2_integrity_impact}>
                  <Tag label={vulnerability.x_opencti_cvss_v2_integrity_impact}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Availability Impact (A)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v2_availability_impact}>
                  <Tag label={vulnerability.x_opencti_cvss_v2_availability_impact}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Exploitability (E)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v2_exploitability}>
                  <Tag label={vulnerability.x_opencti_cvss_v2_exploitability}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Remediation Level (RL)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v2_remediation_level}>
                  <Tag label={vulnerability.x_opencti_cvss_v2_remediation_level}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Report Confidence (RC)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v2_report_confidence}>
                  <Tag label={vulnerability.x_opencti_cvss_v2_report_confidence}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Temporal Score')}
                </Label>
                <Stack direction="row" gap={1}>
                  <ItemCvssScore score={vulnerability.x_opencti_cvss_v2_temporal_score ?? 0} />
                  <ItemSeverity
                    severity={getCvssCriticity(vulnerability.x_opencti_cvss_v2_temporal_score)}
                    label={getCvssCriticity(vulnerability.x_opencti_cvss_v2_temporal_score)}
                    variant="high"
                  />
                </Stack>
              </Grid>
            </Grid>
          )}
          {value === 1 && (
            <Grid container spacing={2} style={{ margin: 10, alignSelf: 'flex-start' }}>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Score')}
                </Label>
                <Stack direction="row" gap={1}>
                  <ItemCvssScore score={vulnerability.x_opencti_cvss_base_score ?? 0} />
                  <ItemSeverity
                    severity={vulnerability.x_opencti_cvss_base_severity}
                    label={vulnerability.x_opencti_cvss_base_severity}
                    variant="high"
                  />
                </Stack>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Vector')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_vector_string}>
                  <Tag label={vulnerability.x_opencti_cvss_vector_string}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Attack Vector (AV)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_attack_vector}>
                  <Tag label={vulnerability.x_opencti_cvss_attack_vector}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Attack Complexity (AC)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_attack_complexity}>
                  <Tag label={vulnerability.x_opencti_cvss_attack_complexity}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Privileges Required (PR)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_privileges_required}>
                  <Tag label={vulnerability.x_opencti_cvss_privileges_required}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('User interaction (UI)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_user_interaction}>
                  <Tag label={vulnerability.x_opencti_cvss_user_interaction}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Scope (S)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_scope}>
                  <Tag label={vulnerability.x_opencti_cvss_scope}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Confidentiality impact (C)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_confidentiality_impact}>
                  <Tag label={vulnerability.x_opencti_cvss_confidentiality_impact}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Integrity Impact (I)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_integrity_impact}>
                  <Tag label={vulnerability.x_opencti_cvss_integrity_impact}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Availability Impact (A)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_availability_impact}>
                  <Tag label={vulnerability.x_opencti_cvss_availability_impact}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Exploit Code Maturity (E)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_exploit_code_maturity}>
                  <Tag label={vulnerability.x_opencti_cvss_exploit_code_maturity}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Remediation Level (RL)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_remediation_level}>
                  <Tag label={vulnerability.x_opencti_cvss_remediation_level}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Report Confidence (RC)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_report_confidence}>
                  <Tag label={vulnerability.x_opencti_cvss_report_confidence}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Temporal Score')}
                </Label>
                <Stack direction="row" gap={1}>
                  <ItemCvssScore score={vulnerability.x_opencti_cvss_temporal_score ?? 0} />
                  <ItemSeverity
                    severity={getCvssCriticity(vulnerability.x_opencti_cvss_temporal_score)}
                    label={getCvssCriticity(vulnerability.x_opencti_cvss_temporal_score)}
                    variant="high"
                  />
                </Stack>
              </Grid>
            </Grid>
          )}
          {value === 2 && (
            <Grid container spacing={2} style={{ margin: 10, alignSelf: 'flex-start' }}>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Score')}
                </Label>
                <Stack direction="row" gap={1}>
                  <ItemCvssScore score={vulnerability.x_opencti_cvss_v4_base_score ?? 0} />
                  <ItemSeverity
                    severity={vulnerability.x_opencti_cvss_v4_base_severity}
                    label={vulnerability.x_opencti_cvss_v4_base_severity}
                    variant="high"
                  />
                </Stack>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Vector')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_vector_string}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_vector_string}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Attack Vector (AV)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_attack_vector}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_attack_vector}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Attack Complexity (AC)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_attack_complexity}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_attack_complexity}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Attack Requirements (AT)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_attack_requirements}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_attack_requirements}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Privileges Required (PR)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_privileges_required}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_privileges_required}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('User Interaction (UI)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_user_interaction}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_user_interaction}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('VS Confidentiality Impact (VC)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_confidentiality_impact_v}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_confidentiality_impact_v}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('SS Confidentiality Impact (SC)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_confidentiality_impact_s}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_confidentiality_impact_s}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('VS Integrity Impact (VI)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_integrity_impact_v}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_integrity_impact_v}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('SS Integrity Impact (SI)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_integrity_impact_s}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_integrity_impact_s}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('VS Availability Impact (VA)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_availability_impact_v}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_availability_impact_v}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('SS Avalability Impact (SA)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_availability_impact_s}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_availability_impact_s}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
              <Grid item xs={6}>
                <Label>
                  {t_i18n('Exploit Maturity (E)')}
                </Label>
                <FieldOrEmpty source={vulnerability.x_opencti_cvss_v4_exploit_maturity}>
                  <Tag label={vulnerability.x_opencti_cvss_v4_exploit_maturity}>
                  </Tag>
                </FieldOrEmpty>
              </Grid>
            </Grid>
          )}
        </Box>
        <Grid container spacing={2}>
          <Grid item xs={6}>
            <VulnerabilitySoftwaresHas vulnerabilityData={vulnerability} />
          </Grid>
          <Grid item xs={6}>
            <VulnerabilitySoftwaresRemediates vulnerabilityData={vulnerability} />
          </Grid>
        </Grid>
      </Card>
    </div>
  );
};

const VulnerabilityDetails = createFragmentContainer(
  VulnerabilityDetailsComponent,
  {
    vulnerability: graphql`
      fragment VulnerabilityDetails_vulnerability on Vulnerability {
        id
        name
        description
        x_opencti_aliases
        x_opencti_cvss_vector_string
        x_opencti_cvss_base_score
        x_opencti_cvss_base_severity
        x_opencti_cvss_attack_vector
        x_opencti_cvss_attack_complexity
        x_opencti_cvss_privileges_required
        x_opencti_cvss_user_interaction
        x_opencti_cvss_scope
        x_opencti_cvss_confidentiality_impact
        x_opencti_cvss_integrity_impact
        x_opencti_cvss_availability_impact
        x_opencti_cvss_exploit_code_maturity
        x_opencti_cvss_remediation_level
        x_opencti_cvss_report_confidence
        x_opencti_cvss_temporal_score
        x_opencti_cvss_v2_vector_string
        x_opencti_cvss_v2_base_score
        x_opencti_cvss_v2_access_vector
        x_opencti_cvss_v2_access_complexity
        x_opencti_cvss_v2_authentication
        x_opencti_cvss_v2_confidentiality_impact
        x_opencti_cvss_v2_integrity_impact
        x_opencti_cvss_v2_availability_impact
        x_opencti_cvss_v2_exploitability
        x_opencti_cvss_v2_remediation_level
        x_opencti_cvss_v2_report_confidence
        x_opencti_cvss_v2_temporal_score
        x_opencti_cvss_v4_vector_string
        x_opencti_cvss_v4_base_score
        x_opencti_cvss_v4_base_severity
        x_opencti_cvss_v4_attack_vector
        x_opencti_cvss_v4_attack_complexity
        x_opencti_cvss_v4_attack_requirements
        x_opencti_cvss_v4_privileges_required
        x_opencti_cvss_v4_user_interaction
        x_opencti_cvss_v4_confidentiality_impact_v
        x_opencti_cvss_v4_confidentiality_impact_s
        x_opencti_cvss_v4_integrity_impact_v
        x_opencti_cvss_v4_integrity_impact_s
        x_opencti_cvss_v4_availability_impact_v
        x_opencti_cvss_v4_availability_impact_s
        x_opencti_cvss_v4_exploit_maturity
        x_opencti_cwe
        x_opencti_cisa_kev
        x_opencti_epss_score
        x_opencti_epss_percentile
        x_opencti_score
        x_opencti_first_seen_active
        ...VulnerabilitySoftwaresHas_vulnerability
        ...VulnerabilitySoftwaresRemediates_vulnerability
      }
    `,
  },
);

export default VulnerabilityDetails;
