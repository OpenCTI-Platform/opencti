import React, { FunctionComponent } from 'react';
import { graphql, useFragment, useMutation } from 'react-relay';
import { Field, Form, Formik } from 'formik';
import * as Yup from 'yup';
import { FormikConfig } from 'formik/dist/types';
import TextField from '../../../../components/TextField';
import { SubscriptionFocus } from '../../../../components/Subscription';
import CommitMessage from '../../common/form/CommitMessage';
import { adaptFieldValue } from '../../../../utils/String';
import { useFormatter } from '../../../../components/i18n';
import { Option } from '../../common/form/ReferenceField';
import { MalwareAnalysisEditionDetails_malwareAnalysis$key } from './__generated__/MalwareAnalysisEditionDetails_malwareAnalysis.graphql';
import { MalwareAnalysisEditionDetailsFocusMutation } from './__generated__/MalwareAnalysisEditionDetailsFocusMutation.graphql';
import { MalwareAnalysisEditionDetailsFieldPatchMutation as FieldPatchMutation } from './__generated__/MalwareAnalysisEditionDetailsFieldPatchMutation.graphql';
import DateTimePickerField from '../../../../components/DateTimePickerField';
import { useSchemaCreationValidation } from '../../../../utils/hooks/useEntitySettings';
import { RelayError } from '../../../../relay/relayTypes';
import { MESSAGING$ } from '../../../../relay/environment';

const malwareAnalysisMutationFieldPatch = graphql`
    mutation MalwareAnalysisEditionDetailsFieldPatchMutation(
        $id: ID!
        $input: [EditInput]!
        $commitMessage: String
        $references: [String]
    ) {
        malwareAnalysisFieldPatch(id: $id, input: $input, commitMessage: $commitMessage, references: $references){
            ...MalwareAnalysisEditionDetails_malwareAnalysis
            ...MalwareAnalysis_malwareAnalysis
        }

    }
`;

export const malwareAnalysisEditionDetailsFocus = graphql`
    mutation MalwareAnalysisEditionDetailsFocusMutation($id: ID!, $input: EditContext!) {
        malwareAnalysisContextPatch(id: $id,  input: $input) {
            id
        }
    }
`;

export const malwareAnalysisEditionDetailsFragment = graphql`
    fragment MalwareAnalysisEditionDetails_malwareAnalysis on MalwareAnalysis {
        id
        configuration_version
        analysis_started
        analysis_ended
        analysis_engine_version
        analysis_definition_version
        modules
    }
`;
interface MalwareAnalysisEditionDetailsProps {
  malwareAnalysisRef: MalwareAnalysisEditionDetails_malwareAnalysis$key,
  context: readonly ({
    readonly focusOn: string | null;
    readonly name: string;
  } | null)[] | null
  enableReferences?: boolean
  handleClose: () => void
}

interface MalwareAnalysisEditionFormValues {
  message?: string
  references?: Option[]
  configuration_version?: string
  modules?: string
}

// eslint-disable-next-line max-len
const MalwareAnalysisEditionDetails: FunctionComponent<MalwareAnalysisEditionDetailsProps> = ({ malwareAnalysisRef, context, enableReferences = false, handleClose }) => {
  const { t } = useFormatter();
  const basicShape = {
    configuration_version: Yup.string().nullable(),
    analysis_started: Yup.date().nullable(),
    analysis_ended: Yup.string().nullable(),
    analysis_engine_version: Yup.string().nullable(),
    analysis_definition_version: Yup.string().nullable(),
    modules: Yup.array().nullable(),
  };
  const malwareAnalysisDetailsValidator = useSchemaCreationValidation('Malware-Analysis', basicShape);
  const malwareAnalysis = useFragment(malwareAnalysisEditionDetailsFragment, malwareAnalysisRef);

  const [commitFieldPatch] = useMutation<FieldPatchMutation>(malwareAnalysisMutationFieldPatch);
  const [commitEditionDetailsFocus] = useMutation<MalwareAnalysisEditionDetailsFocusMutation>(malwareAnalysisEditionDetailsFocus);

  const handleChangeFocus = (name: string) => {
    commitEditionDetailsFocus({
      variables: {
        id: malwareAnalysis.id,
        input: {
          focusOn: name,
        },
      },
    });
  };

  const handleSubmitField = (name: string, value: string) => {
    if (!enableReferences) {
      const finalValue: string = value as string;
      malwareAnalysisDetailsValidator
        .validateAt(name, { [name]: value })
        .then(() => {
          commitFieldPatch({
            variables: {
              id: malwareAnalysis.id,
              input: [{ key: name, value: [finalValue ?? ''] }],
            },
          });
        })
        .catch(() => false);
    }
  };

  const handleSubmitModules = (name: string, value: string) => {
    if (!enableReferences) {
      const finalValue = value && value.length > 0 ? value.split('\n') : [];
      malwareAnalysisDetailsValidator
        .validateAt(name, { [name]: value })
        .then(() => {
          commitFieldPatch({
            variables: {
              id: malwareAnalysis.id,
              input: [{ key: name, value: finalValue }],
            },
          });
        })
        .catch(() => false);
    }
  };

  const onSubmit: FormikConfig<MalwareAnalysisEditionFormValues>['onSubmit'] = (values, { setSubmitting }) => {
    const { message, references, ...otherValues } = values;
    const commitMessage = message ?? '';
    const commitReferences = (references ?? []).map(({ value }) => value);

    const inputValues = Object.entries({
      ...otherValues,
      modules: values.modules?.split('\n') ?? [],
    }).map(([key, value]) => ({ key, value: adaptFieldValue(value) }));

    commitFieldPatch({
      variables: {
        id: malwareAnalysis.id,
        input: inputValues,
        commitMessage: commitMessage.length > 0 ? commitMessage : null,
        references: commitReferences,
      },
      onCompleted: () => {
        setSubmitting(false);
        handleClose();
      },
      onError: (error) => {
        const { errors } = (error as unknown as RelayError).res;
        MESSAGING$.notifyError(errors.at(0)?.data.reason);
        setSubmitting(false);
      },
    });
  };
  const initialValues = {
    configuration_version: malwareAnalysis.configuration_version ?? '',
    analysis_started: malwareAnalysis.analysis_started,
    analysis_ended: malwareAnalysis.analysis_ended,
    analysis_engine_version: malwareAnalysis.analysis_engine_version,
    analysis_definition_version: malwareAnalysis.analysis_definition_version,
    modules: (malwareAnalysis.modules ?? []).join('\n'),
  };
  return (
        <Formik
            enableReinitialize
            initialValues={initialValues}
            validationSchema={malwareAnalysisDetailsValidator}
            onSubmit={onSubmit}
        >
            {({
              submitForm,
              isSubmitting,
              setFieldValue,
              values,
            }) => (
                <Form style={{ margin: '20px 0 20px 0' }}>
                    <Field
                        component={TextField}
                        variant="standard"
                        name="configuration_version"
                        label={t('Configuration version')}
                        fullWidth
                        onFocus={handleChangeFocus}
                        onSubmit={handleSubmitField}
                        helperText={
                            <SubscriptionFocus context={context} fieldName="configuration_version" />
                        }
                    />
                  <Field
                      component={DateTimePickerField}
                      name="analysis_started"
                      label={t('Analysis started')}
                      onFocus={handleChangeFocus}
                      onSubmit={handleSubmitField}
                      TextFieldProps={{
                        label: t('Analysis started'),
                        variant: 'standard',
                        fullWidth: true,
                        style: { marginTop: 20 },
                        helperText: (
                            <SubscriptionFocus context={context} fieldName="analysis_started" />
                        ),
                      }}
                  />
                  <Field
                      component={DateTimePickerField}
                      name="analysis_ended"
                      label={t('Analysis ended')}
                      onFocus={handleChangeFocus}
                      onSubmit={handleSubmitField}
                      TextFieldProps={{
                        label: t('Analysis ended'),
                        variant: 'standard',
                        fullWidth: true,
                        style: { marginTop: 20 },
                        helperText: (
                            <SubscriptionFocus context={context} fieldName="analysis_ended" />
                        ),
                      }}
                  />
                  <Field
                      component={TextField}
                      variant="standard"
                      name="analysis_engine_version"
                      label={t('Analysis engine version')}
                      style={{ marginTop: 20 }}
                      fullWidth
                      onFocus={handleChangeFocus}
                      onSubmit={handleSubmitField}
                      helperText={
                        <SubscriptionFocus context={context} fieldName="analysis_engine_version" />
                      }
                  />
                  <Field
                      component={TextField}
                      variant="standard"
                      name="analysis_definition_version"
                      label={t('Analysis definition version')}
                      style={{ marginTop: 20 }}
                      fullWidth
                      onFocus={handleChangeFocus}
                      onSubmit={handleSubmitField}
                      helperText={
                        <SubscriptionFocus context={context} fieldName="analysis_definition_version" />
                      }
                  />
                  <Field
                      component={TextField}
                      variant="standard"
                      name="modules"
                      label={t('Modules (1 / line)')}
                      fullWidth
                      multiline
                      rows="4"
                      style={{ marginTop: 20 }}
                      onFocus={handleChangeFocus}
                      onSubmit={handleSubmitModules}
                      helperText={
                        <SubscriptionFocus context={context} fieldName="modules" />
                      }
                  />
                    {enableReferences && (
                        <CommitMessage
                            submitForm={submitForm}
                            disabled={isSubmitting}
                            setFieldValue={setFieldValue}
                            values={values.references}
                            id={malwareAnalysis.id}
                            open={false}
                        />
                    )}
                </Form>
            )}
        </Formik>
  );
};

export default MalwareAnalysisEditionDetails;
