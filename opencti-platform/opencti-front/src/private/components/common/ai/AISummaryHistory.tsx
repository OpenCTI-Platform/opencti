import { graphql, useSubscription } from 'react-relay';
import React, { useCallback, useEffect, useMemo, useState } from 'react';
import Alert from '@mui/material/Alert';
import Tooltip from '@mui/material/Tooltip';
import parse from 'html-react-parser';
import { AISummaryHistorySubscription, AISummaryHistorySubscription$data } from '@components/common/ai/__generated__/AISummaryHistorySubscription.graphql';
import { GraphQLSubscriptionConfig } from 'relay-runtime';
import Divider from '@mui/material/Divider';
import Typography from '@mui/material/Typography';
import IconButton from '@common/button/IconButton';
import { AutoModeOutlined, ContentCopyOutlined } from '@mui/icons-material';
import { AISummaryHistoryStixCoreObjectAskAiHistoryQuery$data } from '@components/common/ai/__generated__/AISummaryHistoryStixCoreObjectAskAiHistoryQuery.graphql';
import { useFormatter } from '../../../../components/i18n';
import { getDefaultAiLanguage } from '../../../../utils/ai/Common';
import { fetchQuery } from '../../../../relay/environment';
import { copyToClipboard, cleanHtmlTags } from '../../../../utils/utils';

const subscription = graphql`
    subscription AISummaryHistorySubscription($id: ID!) {
        aiBus(id: $id) {
            content
        }
    }
`;

const aISummaryHistoryQuery = graphql`
  query AISummaryHistoryStixCoreObjectAskAiHistoryQuery($id: ID!, $language: String, $forceRefresh: Boolean) {
      stixCoreObjectAskAiHistory(id: $id, language: $language, forceRefresh: $forceRefresh) {
        result
        updated_at
    }
  }
`;

interface AISummaryHistoryComponentProps {
  refetch: () => void;
  language: string;
  setLanguage: (language: string) => void;
  content: string;
  loading: boolean;
  result: AISummaryHistoryStixCoreObjectAskAiHistoryQuery$data | null;
}

const AISummaryHistoryComponent = ({
  refetch,
  content,
  result,
  loading,
}: AISummaryHistoryComponentProps) => {
  const { t_i18n, nsdt } = useFormatter();
  return (
    <>
      <Alert severity="info" variant="outlined" style={{ marginTop: 20 }}>
        {t_i18n('This summary is based on the history of this entity (internal activity). It has been generated by AI and can contain mistakes.')}
      </Alert>
      {parse(content)}
      {!loading && (
        <>
          <Divider />
          <div style={{ float: 'right', marginTop: 20, display: 'flex', alignItems: 'center', gap: '5px' }}>
            <Typography variant="caption">Generated on {nsdt(result?.stixCoreObjectAskAiHistory?.updated_at)}.</Typography>
            <Tooltip title={t_i18n('Copy to clipboard')}>
              <IconButton size="small" color="primary" onClick={() => copyToClipboard(t_i18n, content)}>
                <ContentCopyOutlined fontSize="small" />
              </IconButton>
            </Tooltip>
            <Tooltip title={t_i18n('Retry')}>
              <IconButton size="small" color="primary" onClick={() => refetch()}>
                <AutoModeOutlined fontSize="small" />
              </IconButton>
            </Tooltip>
          </div>
        </>
      )}
    </>
  );
};

interface AISummaryHistoryProps {
  id: string;
  loading: boolean;
  setLoading: (loading: boolean) => void;
}

const AISummaryHistory = ({ id, loading, setLoading }: AISummaryHistoryProps) => {
  const busId = `${id}-history`;
  const defaultLanguageName = getDefaultAiLanguage();
  const [content, setContent] = useState('');
  const [result, setResult] = useState<AISummaryHistoryStixCoreObjectAskAiHistoryQuery$data | null>(null);
  const [language, setLanguage] = useState(defaultLanguageName);

  // Subscription
  const handleResponse = (response: AISummaryHistorySubscription$data | null | undefined) => {
    const newContent = response ? (response as AISummaryHistorySubscription$data).aiBus?.content : null;
    const finalContent = cleanHtmlTags(newContent);
    return setContent(finalContent);
  };
  const subConfig = useMemo<GraphQLSubscriptionConfig<AISummaryHistorySubscription>>(
    () => ({
      subscription,
      variables: { id: busId },
      onNext: handleResponse,
    }),
    [busId],
  );
    // TODO: Check by the engineering team
    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
    // @ts-ignore
  useSubscription(subConfig);

  // Query
  const queryParams = {
    busId,
    id,
    language,
  };
  useEffect(() => {
    setLoading(true);
    fetchQuery(aISummaryHistoryQuery, queryParams).toPromise().then((data) => {
      const resultData = data as AISummaryHistoryStixCoreObjectAskAiHistoryQuery$data;
      if (resultData && resultData.stixCoreObjectAskAiHistory) {
        setResult(resultData);
        setContent(resultData.stixCoreObjectAskAiHistory.result ?? '');
        setLoading(false);
      }
    });
  }, []);

  const refetch = useCallback(() => {
    setContent('');
    setLoading(true);
    fetchQuery(aISummaryHistoryQuery, { ...queryParams, forceRefresh: true }).toPromise().then((data) => {
      const resultData = data as AISummaryHistoryStixCoreObjectAskAiHistoryQuery$data;
      if (resultData && resultData.stixCoreObjectAskAiHistory) {
        setResult(resultData);
        setContent(resultData.stixCoreObjectAskAiHistory.result ?? '');
        setLoading(false);
      }
    });
  }, []);

  return (
    <AISummaryHistoryComponent
      language={language}
      setLanguage={setLanguage}
      refetch={refetch}
      content={content}
      result={result}
      loading={loading}
    />
  );
};

export default AISummaryHistory;
