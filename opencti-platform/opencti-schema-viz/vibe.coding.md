# Vibe Coding Session: OpenCTI Schema Visualization

This document captures the journey, architectural decisions, and technical details of the **OpenCTI Schema Viz** project, built during our vibe coding session.

## üéØ Project Objective

**Goal**: Create a high-quality, developer-friendly visualization tool for the OpenCTI Graph Schema.
**Key Requirements**:
1.  **Strict Layout**: Perfect alignment, no overlapping, clean edges.
2.  **Accuracy**: Validate attributes against strict STIX 2.1 specifications.
3.  **Usability**: Effective filtering, exact-match focus, and intuitive navigation.
4.  **Zero-Touch Backend**: The tool resides in a separate frontend package (`opencti-schema-viz`) but relies on the `opencti-graphql` backend as a data source without modifying it.

## üèóÔ∏è Architecture & Evolution

### 1. Script Relocation & DX
*   **Initial State**: The schema generation script lived in `opencti-graphql/script`.
*   **Challenge**: Frontend developers needed to switch contexts to regenerate the graph.
*   **Solution**: Moved the script to `opencti-schema-viz/scripts/generate-graph.ts`.
*   **Technical Detail**: The script uses a "Context Switch" pattern. It temporarily changes `process.chdir` and `process.env.INIT_CWD` to `../../opencti-graphql` during execution. This allows it to load backend configuration and modules (like `conf.js` and `webjs`) as if it were running natively in the backend, while keeping the script physically located in the frontend project.

### 2. Graph Layout & Design
*   **Engine**: React Flow + Dagre (Layout).
*   **Layout Strategy**: `ranker: 'tight-tree'`. This was chosen over `network-simplex` or `longest-path` to enforce strict vertical alignment of nodes at the same hierarchy depth.
*   **Node Sizing**:
    *   **Width**: Fixed at `500px` for uniformity.
    *   **Height**: Dynamic. Calculated as `Base + (ItemCount * HeightPerItem)` to ensure containers perfectly fit their content without internal scrolling or whitespace.
*   **Overflow**: CSS `overflow: hidden` applied to `html`, `body`, and `#root` with `width: 100%` to eliminate persistent horizontal scrollbars caused by React Flow's canvas.

### 3. Attribute Validation (STIX)
*   **Problem**: Distinguishing between standard STIX attributes and OpenCTI extensions.
*   **Solution**: Automated compliance checking.
    *   The generation script auto-downloads official STIX 2.1 JSON schemas (`oasis-open/cti-stix2-json-schemas`) if missing.
    *   It validates every attribute against the specific schema for its type (e.g., `Malware` vs `sdo` vs `relationship`).
    *   Attributes found in the spec are marked `isStix: true`; others `isStix: false`.

### 4. Grouping & Navigation
*   **Target Grouping**: To reduce graph clutter, generic relationship targets are grouped.
    *   **Entities**: Displayed in Gray with Link behavior (Jump to node).
    *   **Relationships**: Displayed in Pink (Visual indicator only) with no redirection.
*   **Inheritance**: "Is-A" relationships (Parent/Child) use distinct edge handling to connect visually from "Child Top" to "Parent Bottom", reinforcing the hierarchy.

## üõ†Ô∏è Traceability: Implementation Map

| Feature | Source Location | Description |
| :--- | :--- | :--- |
| **Generation Script** | `scripts/generate-graph.ts` | The brain. Extracts entities, validates STIX, exports JSON. |
| **Layout Logic** | `src/App.tsx` (`getLayoutedElements`) | Computes Dagre positions, applies dynamic sizing. |
| **Node Rendering** | `src/CustomNode.tsx` | Renders the Entity node with expandable attributes. |
| **Group Rendering** | `src/TargetGroupNode.tsx` | Renders the list of targets (Entity/Rel distinction). |
| **Project Config** | `package.json` | Added `yarn generate` command for ease of use. |

## üßπ Backend Hygiene

A critical constraint was "no direct change" to the `opencti-graphql` repository.
*   **Verification**: Ran `git status` in `opencti-graphql`.
*   **Cleanup**: Removed temporary debug scripts (`debug-schema.js`) and build artifacts (`builder-export.js`) that were used seamlessly during the dev process.
*   **Result**: The backend repo remains pristine.

---
*Generated by Antigravity during Vibe Coding Session - Jan 2026*
