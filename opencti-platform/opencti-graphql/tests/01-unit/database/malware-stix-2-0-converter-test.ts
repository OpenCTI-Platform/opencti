import { describe, it, expect, vi, afterEach } from 'vitest';

import { ENTITY_TYPE_MALWARE } from '../../../src/schema/stixDomainObject';
import { convertMalwareToStix, convertTypeToStix2Type } from '../../../src/database/stix-2-0-converter';
import { MALWARE } from './malware-stix-2-0-converter/instances';

const expectedMalware = {
  id: 'malware--96b4c693-3ee7-5875-8a4a-df033289f23a',
  spec_version: '2.0',
  revoked: false,
  confidence: 100,
  created: '2025-03-19T12:45:57.417Z',
  modified: '2025-03-28T14:44:22.142Z',
  name: 'Malware Stix 2.0',
  description: 'a Malware for  STIX 2.0 testing purpose',
  aliases: [
    'mal2',
  ],
  malware_types: [
    'remote-access-trojan'
  ],
  is_family: false,
  first_seen: '2025-03-03T23:00:00.000Z',
  last_seen: '2025-03-26T23:00:00.000Z',
  architecture_execution_envs: [
    'powerpc'
  ],
  implementation_languages: [
    'c'
  ],
  capabilities: [
    'anti-vm'
  ],
  x_opencti_workflow_id: '422a6107-b0e2-4d94-9029-f2acc58a1856',
  labels: [
    'small'
  ],
  kill_chain_phases: [
    {
      kill_chain_name: 'mitre-pre-attack',
      phase_name: 'launch',
      x_opencti_order: 3
    }
  ],
  x_opencti_id: 'd86d8f38-42e2-4c6f-a016-9c7aabb22f03',
  x_opencti_type: 'Malware',
  type: 'malware',
  created_by_ref: 'identity--2fed0f55-e483-5feb-b212-7b6fc58742a0',
  x_opencti_granted_refs: [
    'identity--de5c5845-c96c-5226-99ae-052153c3f557'
  ],
  object_marking_refs: [
    'marking-definition--826578e1-40ad-459f-bc73-ede076f81f37'
  ],
  external_references: [
    {
      source_name: '20th January \u2013 Threat Intelligence Report',
      description: 'bug nino 20th January \u2013 Threat Intelligence Report. Retrieved 2025-01-20T15:03:57.000Z.',
      url: 'https://research.checkpoint.com/2025/20th-january-threat-intelligence-report/'
    }
  ],
  operating_system_refs: [
    'software--8e2a8f2a-9358-5ed5-a776-efdcc5c8e826'
  ],
  samples: [
    {
      id: 'd5f26fd3-c51a-4d5a-ae89-b15340ae4c0b'
    }
  ],
  sample_refs: [
    'file--702e320e-43b6-552a-b7e7-d045bf9c887d'
  ],
  x_opencti_sample_refs_ids: [
    'd5f26fd3-c51a-4d5a-ae89-b15340ae4c0b'
  ],
  x_opencti_files: [
    {
      name: '2025-04-24t09_55_21+02_00_global.txt.json',
      data: 'eyJ0eXBlIjogImJ1bmRsZSIsICJpZCI6ICJidW5kbGUtLTI3NGMyNmY2LTUzOGQtNDUxOC05NzMxLTJlMjUxYTMxZmZhZCIsICJvYmplY3RzIjogW3sidHlwZSI6ICJpcHY0LWFkZHIiLCAic3BlY192ZXJzaW9uIjogIjIuMSIsICJpZCI6ICJpcHY0LWFkZHItLTc2ZWE3NTM5LWJmMjYtNTlhMy05NjU0LTRlN2Q2MmJlZmU5ZSIsICJ2YWx1ZSI6ICIyMi40NS44OS42IiwgInhfb3BlbmN0aV9jcmVhdGVfaW5kaWNhdG9yIjogZmFsc2V9LCB7InR5cGUiOiAiZ3JvdXBpbmciLCAic3BlY192ZXJzaW9uIjogIjIuMSIsICJpZCI6ICJncm91cGluZy0tOTM5M2E5OWYtOTIyMS01OTA3LWEwNDctYjQ4Y2U3N2VlNDM0IiwgImNyZWF0ZWQiOiAiMjAyNS0wNC0yNFQwNzo1NTowNy40NDJaIiwgIm1vZGlmaWVkIjogIjIwMjUtMDQtMjRUMDc6NTU6MDcuNDQyWiIsICJuYW1lIjogIlRlc3RHcm91cElEIiwgImNvbnRleHQiOiAidW5zcGVjaWZpZWQiLCAib2JqZWN0X3JlZnMiOiBbImlwdjQtYWRkci0tNzZlYTc1MzktYmYyNi01OWEzLTk2NTQtNGU3ZDYyYmVmZTllIl0sICJjb25maWRlbmNlIjogMTAwLCAieF9vcGVuY3RpX2lkIjogIjNjZDNkMWMyLTFkM2EtNGRkNi1hZWVlLTc5ODE2YmRhZjc2OCIsICJ4X29wZW5jdGlfdHlwZSI6ICJHcm91cGluZyJ9XX0=',
      mime_type: 'application/json',
      version: '2025-06-02T15:26:14.005Z'
    }
  ],
};
describe('Stix 2.0 opencti converter', () => {
  afterEach(() => {
    vi.restoreAllMocks();
  });
  vi.mock('../../../src/database/file-storage', () => {
    return {
      getFileContent: vi.fn().mockImplementation((id) => {
        if (id === 'import/Malware/d86d8f38-42e2-4c6f-a016-9c7aabb22f03/2025-04-24t09_55_21+02_00_global.txt.json') {
          return 'eyJ0eXBlIjogImJ1bmRsZSIsICJpZCI6ICJidW5kbGUtLTI3NGMyNmY2LTUzOGQtNDUxOC05NzMxLTJlMjUxYTMxZmZhZCIsICJvYmplY3RzIjogW3sidHlwZSI6ICJpcHY0LWFkZHIiLCAic3BlY192ZXJzaW9uIjogIjIuMSIsICJpZCI6ICJpcHY0LWFkZHItLTc2ZWE3NTM5LWJmMjYtNTlhMy05NjU0LTRlN2Q2MmJlZmU5ZSIsICJ2YWx1ZSI6ICIyMi40NS44OS42IiwgInhfb3BlbmN0aV9jcmVhdGVfaW5kaWNhdG9yIjogZmFsc2V9LCB7InR5cGUiOiAiZ3JvdXBpbmciLCAic3BlY192ZXJzaW9uIjogIjIuMSIsICJpZCI6ICJncm91cGluZy0tOTM5M2E5OWYtOTIyMS01OTA3LWEwNDctYjQ4Y2U3N2VlNDM0IiwgImNyZWF0ZWQiOiAiMjAyNS0wNC0yNFQwNzo1NTowNy40NDJaIiwgIm1vZGlmaWVkIjogIjIwMjUtMDQtMjRUMDc6NTU6MDcuNDQyWiIsICJuYW1lIjogIlRlc3RHcm91cElEIiwgImNvbnRleHQiOiAidW5zcGVjaWZpZWQiLCAib2JqZWN0X3JlZnMiOiBbImlwdjQtYWRkci0tNzZlYTc1MzktYmYyNi01OWEzLTk2NTQtNGU3ZDYyYmVmZTllIl0sICJjb25maWRlbmNlIjogMTAwLCAieF9vcGVuY3RpX2lkIjogIjNjZDNkMWMyLTFkM2EtNGRkNi1hZWVlLTc5ODE2YmRhZjc2OCIsICJ4X29wZW5jdGlfdHlwZSI6ICJHcm91cGluZyJ9XX0=';
        }
        return '';
      }),
    };
  });
  it('should convert Malware', async () => {
    const result = await convertMalwareToStix(MALWARE, ENTITY_TYPE_MALWARE);
    expect(result).toEqual(expectedMalware);
  });
});

describe('convertTypeToStix2Type tests', () => {
  it('should return type', async () => {
    const types = [
      'Identity',
      'Location',
      'Threat-Actor',
      'StixFile',
      'Case-Incident',
      'Feedback',
      'Case-Rfi',
      'Case-Rft',
      'Task',
      'Data-Component',
      'Data-Source',
      'stix-sighting-relationship',
      'stix-core-relationship'
    ];
    const expectedTypes = [
      'identity',
      'location',
      'threat-actor',
      'file',
      'x-opencti-case-incident',
      'x-opencti-feedback',
      'x-opencti-case-rfi',
      'x-opencti-case-rft',
      'x-opencti-task',
      'x-mitre-data-component',
      'x-mitre-data-source',
      'sighting',
      'relationship'
    ];
    const result = types.map((type) => convertTypeToStix2Type(type));
    expect(result).toEqual(expectedTypes);
  });
});
