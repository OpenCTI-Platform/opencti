import { describe, it, expect } from 'vitest';

import { ENTITY_TYPE_MALWARE } from '../../../src/schema/stixDomainObject';
import { convertMalwareToStix2 } from '../../../src/database/stix-2-0-converter';
import type { StoreEntity } from '../../../src/types/store';

const malware = {
  id: '2ca0cd6b-fe0e-4023-b0ad-a7df4d164474',
  name: 'Malware Stix 2.0',
  description: 'a Malware for  STIX 2.0 testing purpose',
  draftVersion: null,
  aliases: null,
  entity_type: 'Malware',
  created: '2025-02-28T14:25:27.043Z',
  modified: '2025-02-28T14:29:23.757Z',
  is_family: false,
  createdBy: {
    __typename: 'Individual',
    name: 'Test individual',
    id: '05d9d7ab-9d55-4dd9-a7f5-ac258e0a0405'
  },
  objectMarking: [
    {
      id: 'bb35f939-2ac3-4611-b332-5d537d6c083b',
      definition_type: 'PAP',
      definition: 'pap:amber',
      x_opencti_order: 3,
      x_opencti_color: '#d84315'
    }
  ],
  objectLabel: [
    {
      id: '199a2bed-25b0-4708-9b08-c63f17a63ced',
      value: 'small',
      color: '#079587'
    }
  ],
  malware_types: [
    'MalTest'
  ],
  targetedCountries: {
    edges: []
  },
  targetedSectors: {
    edges: []
  },
  relatedIntrusionSets: {
    edges: []
  },
  __typename: 'Malware'
} as unknown as StoreEntity;
const expectedMalware = {
  id: 'malware--96b4c693-3ee7-5875-8a4a-df033289f23a',
  spec_version: '2.1',
  revoked: false,
  confidence: 100,
  created: '2025-02-28T14:25:27.043Z',
  modified: '2025-02-28T14:29:23.757Z',
  name: 'Malware Stix 2.0',
  description: 'a Malware for  STIX 2.0 testing purpose',
  malware_types: [
    'MalTest'
  ],
  is_family: false,
  first_seen: '2025-02-13T23:00:00.000Z',
  last_seen: '2025-02-20T23:00:00.000Z',
  architecture_execution_envs: [
    'powerpc'
  ],
  implementation_languages: [
    'c'
  ],
  capabilities: [
    'anti-vm'
  ],
  labels: [
    'small'
  ],
  kill_chain_phases: [
    {
      kill_chain_name: 'mitre-atlas',
      phase_name: 'impact',
      x_opencti_order: 0
    }
  ],
  x_opencti_id: '2ca0cd6b-fe0e-4023-b0ad-a7df4d164474',
  x_opencti_type: 'Malware',
  type: 'malware',
  created_by_ref: 'identity--5f034bbb-9058-5c56-a369-326aca1348c7',
  x_opencti_granted_refs: [
    'identity--8cb00c79-ab20-5ed4-b37d-337241b96a29'
  ],
  object_marking_refs: [
    'marking-definition--a6f20d4d-0360-59b6-ba22-3b48707828b1'
  ]
};
describe('Stix 2.0 opencti converter', () => {
  it('should convert Malware', async () => {
    const result = convertMalwareToStix2(malware, ENTITY_TYPE_MALWARE);
    expect(result).toEqual(expectedMalware);
  });
});
