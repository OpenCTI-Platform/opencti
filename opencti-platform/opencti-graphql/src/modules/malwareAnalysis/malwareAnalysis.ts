import type { StixMalwareAnalysis, StoreEntityMalwareAnalysis } from './malwareAnalysis-types';
import { ENTITY_TYPE_MALWARE_ANALYSIS, INPUT_ANALYSIS_SCO, INPUT_HOST_VM, INPUT_INSTALLED_SOFTWARE, INPUT_OPERATING_SYSTEM, INPUT_SAMPLE } from './malwareAnalysis-types';
import { ABSTRACT_STIX_DOMAIN_OBJECT } from '../../schema/general';
import malwareAnalysisTypeDefs from './malwareAnalysis.graphql';
import malwareAnalysisResolvers from './malwareAnalysis-resolvers';
import { RELATION_ANALYSIS_OF, RELATION_CHARACTERIZES, RELATION_DYNAMIC_ANALYSIS_OF, RELATION_STATIC_ANALYSIS_OF } from '../../schema/stixCoreRelationship';
import { ENTITY_TYPE_MALWARE } from '../../schema/stixDomainObject';
import { REL_BUILT_IN } from '../../database/stix';
import type { ModuleDefinition } from '../../schema/module';
import { registerDefinition } from '../../schema/module';

import convertMalwareAnalysisToStix from './malwareAnalysis-converter';
import {
  ENTITY_DOMAIN_NAME,
  ENTITY_HASHED_OBSERVABLE_ARTIFACT,
  ENTITY_HASHED_OBSERVABLE_STIX_FILE,
  ENTITY_HOSTNAME,
  ENTITY_NETWORK_TRAFFIC,
  ENTITY_SOFTWARE,
  ENTITY_URL,
  isStixCyberObservable
} from '../../schema/stixCyberObservable';
import {
  ATTRIBUTE_ANALYSIS_SCO,
  ATTRIBUTE_HOST_VM,
  ATTRIBUTE_INSTALLED_SOFTWARE,
  ATTRIBUTE_OPERATING_SYSTEM,
  ATTRIBUTE_SAMPLE,
  RELATION_ANALYSIS_SCO,
  RELATION_HOST_VM,
  RELATION_INSTALLED_SOFTWARE,
  RELATION_OPERATING_SYSTEM,
  RELATION_SAMPLE
} from './malwareAnalysis-domain';
import { objectAssignee, objectOrganization } from '../../schema/stixRefRelationship';

const MALWARE_ANALYSIS_DEFINITION: ModuleDefinition<StoreEntityMalwareAnalysis, StixMalwareAnalysis> = {
  type: {
    id: 'malwareAnalyses',
    name: ENTITY_TYPE_MALWARE_ANALYSIS,
    category: ABSTRACT_STIX_DOMAIN_OBJECT,
    aliased: false
  },
  graphql: {
    schema: malwareAnalysisTypeDefs,
    resolver: malwareAnalysisResolvers
  },
  identifier: {
    definition: {
      [ENTITY_TYPE_MALWARE_ANALYSIS]: [{ src: 'product' }, { src: 'result_name' }, { src: 'submitted' }]
    },
    resolvers: {}
  },
  attributes: [
    { name: 'product', label: 'Product', type: 'string', format: 'short', mandatoryType: 'external', editDefault: true, multiple: false, upsert: true, isFilterable: true },
    { name: 'version', label: 'Version', type: 'string', format: 'short', mandatoryType: 'customizable', editDefault: true, multiple: false, upsert: true, isFilterable: true },
    { name: 'configuration_version', label: 'Configuration version', type: 'string', format: 'short', mandatoryType: 'customizable', editDefault: true, multiple: false, upsert: true, isFilterable: true },
    { name: 'modules', label: 'Modules', type: 'string', format: 'short', mandatoryType: 'customizable', editDefault: true, multiple: true, upsert: true, isFilterable: true },
    { name: 'analysis_engine_version', label: 'Analysis engine version', type: 'string', format: 'short', mandatoryType: 'customizable', editDefault: true, multiple: false, upsert: true, isFilterable: true },
    { name: 'analysis_definition_version', label: 'Analysis definition version', mandatoryType: 'customizable', editDefault: true, type: 'string', format: 'short', multiple: false, upsert: true, isFilterable: true },
    { name: 'submitted', label: 'Submission date', type: 'date', mandatoryType: 'customizable', editDefault: true, multiple: false, upsert: true, isFilterable: true },
    { name: 'analysis_started', label: 'Analysis started', type: 'date', mandatoryType: 'customizable', editDefault: true, multiple: false, upsert: true, isFilterable: true },
    { name: 'analysis_ended', label: 'Analysis ended', type: 'date', mandatoryType: 'customizable', editDefault: true, multiple: false, upsert: true, isFilterable: true },
    { name: 'result_name', label: 'Result name', type: 'string', format: 'short', mandatoryType: 'external', editDefault: true, multiple: false, upsert: true, isFilterable: true },
    { name: 'result', label: 'Result', type: 'string', format: 'short', mandatoryType: 'customizable', editDefault: true, multiple: false, upsert: true, isFilterable: true },
  ],
  converter: convertMalwareAnalysisToStix,
  representative: (stix: StixMalwareAnalysis) => {
    return `${stix.product} - ${stix.result_name}`;
  },
  relations: [
    {
      name: RELATION_CHARACTERIZES,
      targets: [
        { name: ENTITY_TYPE_MALWARE, type: REL_BUILT_IN },
      ]
    },
    {
      name: RELATION_ANALYSIS_OF,
      targets: [
        { name: ENTITY_TYPE_MALWARE, type: REL_BUILT_IN },
      ]
    },
    {
      name: RELATION_STATIC_ANALYSIS_OF,
      targets: [
        { name: ENTITY_TYPE_MALWARE, type: REL_BUILT_IN },
      ]
    },
    {
      name: RELATION_DYNAMIC_ANALYSIS_OF,
      targets: [
        { name: ENTITY_TYPE_MALWARE, type: REL_BUILT_IN },
      ]
    },
  ],
  relationsRefs: [
    objectOrganization,
    objectAssignee,
    {
      name: INPUT_HOST_VM,
      type: 'ref',
      databaseName: RELATION_HOST_VM,
      stixName: ATTRIBUTE_HOST_VM,
      mandatoryType: 'no',
      editDefault: false,
      multiple: false,
      upsert: true,
      datable: true,
      checker: (_, toType) => toType === ENTITY_SOFTWARE,
      label: 'VM Host',
      isFilterable: true,
    },
    {
      name: INPUT_OPERATING_SYSTEM,
      type: 'ref',
      databaseName: RELATION_OPERATING_SYSTEM,
      stixName: ATTRIBUTE_OPERATING_SYSTEM,
      mandatoryType: 'no',
      editDefault: false,
      multiple: false,
      upsert: true,
      datable: true,
      label: 'Operating System',
      checker: (_, toType) => toType === ENTITY_SOFTWARE,
      isFilterable: true,
    },
    {
      name: INPUT_INSTALLED_SOFTWARE,
      type: 'ref',
      databaseName: RELATION_INSTALLED_SOFTWARE,
      stixName: ATTRIBUTE_INSTALLED_SOFTWARE,
      mandatoryType: 'no',
      editDefault: false,
      multiple: true,
      upsert: true,
      datable: true,
      label: 'Installed software',
      checker: (fromType, toType) => toType === ENTITY_SOFTWARE,
      isFilterable: true,
    },
    {
      name: INPUT_ANALYSIS_SCO,
      type: 'ref',
      databaseName: RELATION_ANALYSIS_SCO,
      stixName: ATTRIBUTE_ANALYSIS_SCO,
      mandatoryType: 'no',
      editDefault: false,
      multiple: true,
      upsert: true,
      datable: true,
      label: 'Analysis SCO',
      checker: (fromType, toType) => isStixCyberObservable(toType),
      isFilterable: true,
    },
    {
      name: INPUT_SAMPLE,
      type: 'ref',
      databaseName: RELATION_SAMPLE,
      stixName: ATTRIBUTE_SAMPLE,
      mandatoryType: 'no',
      editDefault: false,
      multiple: false,
      upsert: true,
      datable: true,
      checker: (fromType, toType) => [
        ENTITY_HASHED_OBSERVABLE_ARTIFACT,
        ENTITY_HASHED_OBSERVABLE_STIX_FILE,
        ENTITY_NETWORK_TRAFFIC,
        ENTITY_DOMAIN_NAME,
        ENTITY_URL,
        ENTITY_HOSTNAME
      ].includes(toType),
      label: 'Sample',
      isFilterable: true,
    }
  ]

};

registerDefinition(MALWARE_ANALYSIS_DEFINITION);
